### 组播地址
组播地址是D类地址 1110 : 224.0.0.0 - 239.255.255.255
组播地址只能作为目标地址, SIP一定是ABC类地址, DIP一定是D类地址
特定协议使用的组播网段: 224.1.1.1/24
- 224.0.0.1: 所有设备
- 224.0.0.2: 路由器
- 224.0.0.5: OSPF路由器
- 224.0.0.6: OSPF DR/BDR路由器
- 224.0.0.13: PIM路由器

224.0.1.0 - 231.255.255.255: ASM模型, 任意源组播，允许接收任意源发向该组的数据
232.0.0.0 - 232.255.255.255: SSM模型, 特定源组播，只接受特定源发向该组的数据
239.0.0.0 - 239.255.255.255: 组播管理
### 组播MAC地址
IPv4组播MAC地址的高24位为0x01005e，第25位是0，低23位为IPv4组播地址的低23位
```
224.0.1.1
11100000 0|0000000 00000001 00000001
MAC地址前25bit固定 01 00 5e
00000001 00000000 01011110 0|0000000 00000001 00000001   
```
### 组播网络基本架构
组播网络可以分为三个部分
- 源端网络
  将组播源产生的组播数据发送至组播网络
- 组播转发网络
  形成无环的组播转发路径，该路径也称为组播分发树 (Multicast Distribution Tree)
- 成员端网络
  让组播网络感知组播成员位置与加入的组播组

组播源 -> 组播路由器(first hop) -> 组播转发网络(PIM协议) -> 组播路由器(last hop) -> 成员端网络(IGMP组管理协议)
### 组播服务模型
ASM模型, 任意源组播，允许接收任意源发向该组的数据 （\*，G表项）
SSM模型, 特定源组播，只接受特定源发向该组的数据     （S，G表项）
查看组播路由表：`dis pim routing-table` 
### 组播路由与RPF检查
组播数据转发需要依靠路由表项，可能会出现以下问题
- 转发环路，重复报文![[Pasted image 20240819090313.png]]
- 次优路径，重复报文![[{FD006F00-9456-475F-AB3C-3D94AD034DA6} 1.png]]

组播路由表项除了目的网络和出接口外还需要添加组播源和入接口的信息，设备仅转发从特定唯一的入接口收到的组播数据，才可避免组播转发时产生环路，次优和重复报文(部分解决)等问题
对于相同组播源，设备通过RPF（反向路径检查）可以确定设备上唯一的组播流量入接口
RPF可以防止组播报文次优路径以及重复报文
RPF原理：从某个接口收到组播源要保证路由表中去往该组播源的路由的出接口也是该接口，是则接受，不是则丢弃

SIP：1.1.1.1    单播：1.1.1.0 /24    MBGP：1.1.0.0 /16    组播静态：1.0.0.0 /8
同时存在单播路由，MBGP路由，组播静态路由是如何进行RPF检测
1. 先按照最长掩码匹配选择路由，优选最长掩码
   SIP：1.1.1.1    单播：1.1.1.0 /24    MBGP：1.1.0.0 /16    组播静态：1.0.0.0 /8
   选择单播，因为掩码最精确
2. 掩码相同，选择路由优先级最高的；组播静态路由优先级为1
3. 组播静态路由 > MBGP > 单播
### 组播分发树
- 组播数据转发需要保证转发路径无环，无次优，无重复包
- 通过RPF与组播路由协议，组播网络可以形成无环，无次优，无重复包的组播转发路径，该路径可以被称为**组播分发树**
- 组播分发树以**组播源为根**，以**组成员为叶子**形成转发路径，组播数据在转发时都基于组播分发树进行转发
### IGMP协议
#### 概念
Internet Group Mangement Protocol 因特网组管理协议
组成员可以将加组信息发送给组播网络，从而让组播网络感知到组成员的位置和所加组播组
#### 版本
1. V1：定义了基本的组成员查询和报告过程
2. V2：在V1的基础上增加了查询器的选举以及组成员离组机制（ASM模型，默认版本）
3. V3：增加了对指定源的操作（SSM模型）
#### 工作原理
IGMPv1有两种报文
1. 普遍组查询报文（GQ，general query），查询器（last hop）向共享网络里所有主机和路由器发送查询报文，目的是为了了解组播组存在哪些成员
   SIP：GW地址，DIP：224.0.0.1（所有设备）
   默认60秒发送一次![[{072838D3-6004-4B36-8A80-0661E5782501}.png]]
2. 成员报告报文（report），主机向查询器发送的报告报文，用于申请加入某个组或者应答查询报文
   SIP：receiver地址，DIP：加组的组播地址![[{2F6E6769-3913-45F2-B08F-60780DA9AA14} 1.png]]
3. 成员离组叫作默默离开，<font style="color:yellow">没有离组报文发送</font>
>组里没有成员时，默认时间130秒后，IGMP查询器就会删除组的信息

IGMPv2在v1的基础上新增了两种报文
1. 成员离开报文（leave），成员在离组时主动向查询器发送离组报文![[{505C6995-9CB9-44F8-9A15-F96BE3C441FF}.png]]
2. 特定组查询报文（group-specific query），查询器向MA网络内特定的组播组发送的查询报文，用于查询该组是否还要成员![[{2799AC72-8720-4225-94E1-FCAA540111E3}.png]]
3. 增加了一个最大响应时间，只会在查询报文中生效，默认10秒

IGMPv3主要时配合SSM模型使用
1. 查询报文：普遍组查询，特定组查询，特定源查询（group and source -specific query），由查询器向特定组发送，用于查询该组成员是否愿意接收该源的数据![[{16EAC567-318C-4C09-A199-E213995B3F35}.png]]QQLC：IGMP查询器的查询间隔
   离组报文![[{615F977B-2A78-4BBF-B483-65B05C2C0F12}.png]]
2. 成员报告报文：v3没有定义专用于成员离开报文（没有leave报文），但是成员离开是利用特定类型的报告报文来表达；包含加组报文，接收哪些源
   v3的一个成员报告报文可以携带很多组播组信息，报文量可以大大减少
#### 配置
先全局开启组播功能，再在接终端的接口下开启IGMP功能
```
--- IGMPv1 ---
muticast routing-enable
int g0/0/1
	igmp enable

--- 配置验证 ---
dis igmp group    //查看组信息
```
#### IGMP Snooping
IPv4二层组播协议，通过侦听三层组播设备和用户主机之间发送的组播协议报文来维护组播报文的出接口信息，管理和控制数据报文在数据链路层的转发
在二层交换机上配置，让二层交换机可以侦听IGMP报文并分析建立二层组播转发表项；达到<font style="color:yellow">只向特定端口泛洪</font>的目的
两种端口
1. router-port路由器端口，二层组播设备朝向组播路由器的接口（上行口）
2. member-port成员端口，组播成员接口（下游接口）
```
igmp-snooping enable        //全局下开启
vlan 1                      //到对应的vlan下再次开启
	igmp-snooping enable
```
#### IGMP SSM Mapping
可以让IGMPv1 v2也能加入SSM组播网络
当主机不支持v3，只支持v1，v2，无法加入SSM范围的组播组，需要在设备上提供SSM-mapping。
将源和组的映射关系配好，这样v1和v2的报告报文中的（\ \*，G）就会转化为（S，G）
1. v1，v2不支持232.0.0.0/8，v1，v2只能用其他组，但是SSM默认只是232，所以用`SSM policy`（在所有pim设备上做），让pim路由器去认为属于acl中匹配的组播地址采用了SSM模式
2. last hop下行口开启v3，以及`ssm-mapping enable`
3. last hop在IGMP下配置ssm-mapping映射（G/mask，S）
#### IGMP Proxy
设备将成员关系报告/离开报文汇聚后统一上交给IGMP查询器
设备也可以代理IGMP查询器向成员主机发送查询报文。维护组成员关系，基于成员关系进行组播转发
定义了两种接口
1. host interface主机接口：设备上配置Proxy功能的接口，该接口一般面向IGMP查询器
2. Router interface路由器接口：设备上配置IGM功能的接口，该接口一般面向组成员
### PIM协议
#### 概念
protocol independent multicast 协议无关组播
协议无关是指和单播路由协议无关，pim不需要维护专门的单播路由信息
利用单播路由表的路由信息，对组播报文执行RPF检测，检测完成之后创建组播路由表项，从而指导组播报文的转发
- PIM协议分为两种模式
	1. PIM-DM（dense mode）
	2. PIM-SM（sparse mode）
- 组播分发树（MDT  multicast distribution tree）
	1. 以组播源为根，组播成员为叶子；SPT shortest path tree
	   用于DM和SM
	2. 以RP（rendezvous point）为根，组播组成员为叶子；RPT rp tree
	   只用于SM
- PIM路由器
	1. 叶子路由器：连接的主机不应当是组成员
	2. 最后一跳路由器（连接组成员）
	3. 第一跳路由器（连接组播源）
	4. 中间路由器
- PIM路由表项
	- （S，G）：建立SPT
	- （\ \*，G）：建立RPT
	>同时存在两种表项时
	>如果存在（S，G），就以（S，G）为主
	>如果不存在（S，G），只有（\ \*，G），此时会按照（\ \*，G）路由表创建（S，G）路由表，然后按照（S，G）路由表转发
#### PIM-DM
也称为密集模式；用 push 的方式来转发数据包
适用于成员规模小，且相对密集的网络
它会假设每个网段中都有成员，加入一个组播源发送了组播报文，PIM-DM就会将组播源发送过来的组播报文扩散到整个网络的PIM路由器上，在剪掉不存在组成员的分支
<font style="color:dfdf66">flooding扩散，prune剪枝</font>；这个操作是<font style="color:ef4944">周期性</font>的，构建一颗连接组播源和成员的单向无环SPT
如果在下一次扩散-剪枝之前，有被剪枝的叶子路由器上有新增的组成员，那么为了快速转发数据，会进行 <font style="color:dfdf66">graft嫁接</font> 操作，能够快速恢复对剪枝端口的数据转发

关键工作机制
1. 邻居发现：hello报文，DIP：224.0.0.13，发现PIM邻居，协商参数信息（DR优先级越高越优；只在SM中选举DR使用；holdtime邻居超时时间是105秒），用于维护邻居![[{4B93124A-9A3C-4B59-9EDF-41426685FFC4}.png]]
2. 扩散：将接收的组播报文在全网扩散，先进行RPF检测，接着创建（S，G）；叶子路由器上存在组成员，下游口加入到（S，G），后续会向该接口转发组播报文；叶子路由器上不存在组成员时，会进行剪枝
3. 剪枝：PIM路由器会向上游设备发送剪枝报文，通知上游设备禁止向下游接口转发，并且将接口从（S，G）中删除；剪枝是由叶子路由器发起，逐跳向上，会有一个剪枝定时器，到时间会恢复接口转发；剪枝的接口下有新成员，就会进行嫁接![[{28A68BBB-1F7F-49C7-B7DD-73D0E6EFF996}.png]]
4. 嫁接：告诉上游接口恢复剪枝接口![[{C22F20AB-79C9-429B-94FE-0B2B7EC6D328}.png]]
5. 断言：最后一跳路由器上游是个MA网络，可以从三台PIM路由器上收到报文，上游设备会进行路由比较，先比较协议优先级，其次上游设备会进行路由比较，优选自身到达组播源开销小的，最后比较下游接口IP地址大的，解决重复包（优于RBF）![[{43ADE906-F7F1-49E8-B5B5-C7F4DD35DA9F}.png]]
6. 状态刷新：一直没有新成员，会保持接口抑制转发状态，避免剪枝接口在定时器超时后恢复转发；status refresh（离组播源最近的第一跳路由器周期性在全网扩散），收到后会刷新剪枝定时器的状态![[{6BA69D4D-95D9-4629-B8C7-B8885D54F25F}.png]]
#### PIM-SM（ASM）
中大型网络中使用PIM-DM会有以下局限性
1. 扩散-剪枝方式需要全网扩散组播报文，<font style="color:ef5555">对网络有一定冲击</font>
2. 所有组播路由器<font style="color:ef5555">均需要维护组播路由表</font>，即使该组播路由器无需转发组播数据
3. 对于组成员较为稀疏的组播网络，使用扩散-剪枝形成组播分发树的效率不高

SM也称为稀疏模式；用 pull 的方式来转发数据包
- RP 汇聚点（PIM路由器），是最重要的设备，可以为随时出现的组成员或组播源服务，<font style="color:ef5555">网络中所有PIM路由器必须知道RP的位置（环回口地址）</font>
- 最后一跳路由器向RP发送join报文，向RP逐条形成（\ \*，G）表项，形成一颗以RP为根的RPT树
- 活跃的组播源出现时，第一跳路由器会将组播数据封装在 register注册报文 中单播发给RP，在RP上创建（S，G）表项，注册源信息

关键机制
1. 邻居发现：hello包
2. DR竞选：只出现在第一跳或者最后一跳路由器上；在连接组成员的MA网络中，由DR负责向RP发送join报文；在连接组播源的MA网络中，由DR负责向RP发送register报文；选举优选<font style="color:ef5555">优先级高</font>的，优先级一样选<font style="color:ef5555">IP地址大</font>的；一个网段一个DR
3. RP发现：一个RP可以同时为多个组播组服务，但是一个组播组只能对应一个RP
   配置方法
   1. 静态RP：为所有PIM设备手动指定RP地址
   2. 动态RP：在几台PIM设备（C-RP 候选RP）上动态选举RP
	   - C-BSR：优选<font style="color:ef5555">优先级高</font>的，优先级一样选<font style="color:ef5555">IP地址大</font>的；bootstrap（C-BSR的地址，优先级）
	   - C-RP竞选过程：
		   1. C-RP向BSR发送advertisement报文，携带自己的地址，服务组范围，以及优先级
		   2. BSR会将这些信息汇总为一个RP-Set（信息统计表格），封装在bootstrap报文中，发给所有PIM设备
		   3. 各个PIM设备使用相同的规则进行计算和比较（RP）
				   1. 与用户加入的组地址匹配的V-RP服务的组范围掩码最长者获胜
				   2. C-RP优先级高的（数值越小越优）
				   3. hash函数计算，结果大的获胜
				   4. C-RP地址大的（一般是环回口）
1. RPT构建：由叶子路由器向RP(上)逐跳形成（\ \*，G）表项，也会伴随RPF检测；查找到达RP的单播路由，单播路由的出接口为上游接口，下一跳为RPF邻居
2. 组播源注册:任何一个新出现的组播源都必须首先在RP处注册，继而才能将组播报文传输到组成员
	1. 组播源将组播报文发给源端DR
	2. 源端DR，封装在register报文，单播发给RP
	3. RP收到后，解封装，形成（S，G）表项，沿着RPT将组播报文发给组成员
3. <font style="color:ef4444">SPT切换</font>：所有发给组成员的报文都必须先封装在注册报文中发给RP。再有RP解封装沿着RPT发给成员，RP作为报文的中转点
   - PIM-SM允许<font style="color:ef5555">RP</font>或者<font style="color:ef5555">成员端DR</font>来触发SPT切换以缓解RP的压力
   - RP触发SPT切换：RP收到源端过来的注册报文，将封装的注册报文直接沿着SPT转发给成员，同时RP会向源端发起join报文，发送过程中形成（S，G）表项，建立RP到源的SPT；==作用：源端DR可以直接将组播报文转发给RP，减少封装与解封装的频繁过程==
   - 组成员端DR触发SPT，DR会周期性检测组播报文的转发速率，一旦发现（S，G）报文的转发速率超过了阈值，则触发SPT切换
	   1. 成员端DR逐跳向源端DR发送join报文，并创建（S，G），建立源DR和成员DR之间的SPT树
	   2. SPT建立好后，沿着RPT向RP发送剪枝，删除（S，G），剪枝后RP将不再转发组播报文给成员
	   3. 如果SPT不经过RP，RP也会向源端DR发送剪枝，删除（S，G），剪枝后源端将不再沿着 源DR-RP 的SPT树转发报文到RP
	   4. 缺省情况下，设备一般未设置阈值，RP或者成员DR在收到第一份报文时就会触发各自的SPT切换
1. 断言

配置
```
int g0/0/0
	pim sm            //接口下配置
pim
	c-rp lo0          //配置rp，用环回口（环回口也要配置pim sm）
	c-bsr lo0         //成为rp同时也可以成为bsr
```
#### PIM-SM（SSM）
使用PIM-SM部分技术+IGMPv3/MLDv2
- 无需维护RP
- 无需构建RPT
- 无需注册组播源
- 直接在源和组成员直接构建SPT

特点：用户能够预先知道组播源的具体位置，用户在加入组的时候可以明确指定从哪些源接收信息。组成员端DR在了解到用户主机的需求后，可以直接向源端DR发送join报文，逐跳
关键技术
1. 邻居发现
2. DR竞选
3. 构建SPT

### MSDP
multicast source discovery protocol 组播源发现协议
用于跨域组播，只对ASM支持
基于TCP协议，TCP639，keepalive保活
MBGP，组播边界网关协议