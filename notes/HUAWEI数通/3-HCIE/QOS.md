### 概述
quality of service 质量服务（应用广泛）
功能：
1. 流量监管：对进入接口的，超出限制速率的报文进行丢弃
2. 流量整形：对接口发送的，超出限速的报文进行先缓存，等待流量不超出速率时发送
3. 拥塞避免：在出现网络拥塞时，对符合条件的报文进行丢弃
4. 拥塞管理：在出现网络拥塞时，采用队列的方式对符合条件的报文进行优先发送
5. 流策略

传统IP网络对于报文无差别对待（FIFO先入先出，best-effort尽力而为）
按照报文到达的先后顺序分配所需要的资源，尽最大的努力去将报文传输到目标，对报文传输的可靠性，延迟，丢包率等都无法提供任何保障，只适合域服务性能不敏感的业务
新型应用（IP电话，远程教学等）需要实时性和连续性，需要用到QOS，差分服务

### 影响QOS评估
1. 带宽：吞吐量，一定时间内业务流的平均速率，kbit/s，Qos可以针对不同业务流分配不同的带宽
2. 时延：业务穿过网络所需要的平均时间
	- 传输时延：取决于传输距离以及传输介质，跟带宽无关
	- 串行化时延：发送节点在传输链路上开始发送报文的第一个bit直到最后应一个bit所需的时间，与链路带宽，报文的大小有关
	- 处理时延：路由器把报文从入接口放到出接口队列的时间，与路由器的处理性能有关
	- 队列时延：报文在队列中等待的时间，与队列的大小，队列的中报文的数量，队列机制有关
1. 时延抖动：时延的变化
2. 丢包率：业务流在传输过程中的丢失比率，万分之三
	- 处理过程：cpu太高了，无法处理报文而丢弃
	- 排队过程：队列满的情况下会丢包
	- 传输过程：丢包

企业使用QOS的根本原因是==带宽不够==

### QOS优先级（不同报文）
1. 二层vlan报文（802.1p，2^3 0-7最高）
	802.1Q（dot1q），TPID（固定0x8100），PRI（3bit），CFI，vlanID
	7：网络管理和关键性网络流量，路由协议的更新
	5-6：延迟敏感
	1-4：受控负载应用
	0：缺省值
2. 二层mpls报文
	mpls exp（3bit）0-7
3. 三层IP报文
	TOS（type of service 服务类型，8bit）
	```
	XXX X XXX   X
	012 3 456   7
	```
	012：IP precedence（数据包的IP优先级），3bit，0-7（值越大，优先级越高）
	3456：TOS；延时，吞吐量，可靠性，开销；只有一个可以为1，所以只有5个取值
	- 1000：最小时延
	- 0100：最大吞吐量
	- 0010：最高可靠性，max-reliability
	- 0001：最小开销，min-cost
	- 0000：一般服务，normal
	---
	后来把TOS变为DS字段（差分服务），全部利用8个字节；0-5位称为DSCP（差分服务代码点）；0-63，64个优先级；后面6，7位保留（ECN，显示拥塞通知）
	7：固定为0
	[[table#^5db625|表格]]
	RFC 2597：PHB per-hop behavior 逐跳行为
	- 0-4：标识PHB值
	- 0-2：标识PHB的类别 class，8个值，代表CS0 - CS7，三位不能全为0
	- 3-4：PHB的类别选择 selector
	- 5固定为0
	---
	确保转发：AF PHB，DS 0-2PHB类别，34代表丢弃优先级
	AF（X, Y）X代表流分类，Y代表对应的丢弃优先级
	 允许管理员在没有超出线路允许速率的情况下尽可能的保证传输质量，如果超出了速率也可能在拥塞时被丢弃
	 定义了4种PHB类别（流分类）：001（CS1），010（CS2），011（CS3），100（CS4）；本身代表流的不同优先级，再通过34位的丢弃优先级值（取非0的三个值，01，10，11），值越大丢弃优先级越高[[table#^5db625|优先级表格]]
	---
	RFC 3245：加速转发，expedited forwarding，EF，CS5
	101 110：DSCP，46
	实时业务

### QOS三种服务模型
1. best effort（尽力而为）：无区别，缺省，最简单的，FIFO
2. intServ（intergrated service 综合服务，通过信令申请资源）
   RSVP资源预留协议，为某个服务预留了足够的资源，容易造成资源浪费，类似完全公交车道
3. DiffServ（差分服务模型），类似时间公交车道，QOS中的主要模型
   DiffServ模型![[{B46B7079-8488-4368-B707-8FCF6B153BF0}.png]]
	- 流分类：依据一定的匹配规则识别出不同类型的报文，是有区别的实施服务的前提
	- 流量监管：对进入设备的特定流量的规格进行监管，当流量超出规格时可以采取限制或者惩罚的措施
	- 流量整形：一种更主动调整流的输出速率的措施，是流量适配下游设备的可供资源，避免不必要的报文丢弃和拥塞
	- 拥塞管理：在发送网络拥塞时必须采取解决资源竞争的措施，通常时将报文放入队列中缓存，并采取某种调度算法安排报文的转发次序
	- 拥塞避免：过度的拥塞会导致网络资源损耗，拥塞避免可以监督网络资源的使用情况，在发现拥塞有加剧的趋势时采取主动丢弃报文的策略，通过调整流量措施来解除网络过载
### 模块化QOS配置
MQC
- 流分类（traffic classfier）
  二层：DMAC，SMAC，VLANID，802.1q，mpls exp ...
  三层：SIP，DIP，port，DSCP，协议 ...
  其他：所有报文，入接口，出接口 ...
- 流分类规则之间关系
  and：所有都匹配上才行
  or：只有匹配上一个即可
- 流行为：traffic behavior，定义对某个流的行为动作
- 流策略：traffic policy，绑定流的分类和行为，针对分类的报文执行相应的行为
- 应用流策略在 接口下 调用，尽量在入方向

MQC的remark，生成标记是内部优先级，同时也是报文离开时的报文优先级
假如接口同时配置了信任和remark，remark优于信任起作用
#### 配置
```
traffic classifier pc1                //创建流分类pc1
	if-match acl 2000                 //匹配已经写好的acl
traffic behavior pc1                  //创建流行为pc1
	remark dscp cs2                   //重新标记dscp值为cs2(16)
traffic policy QOS                    //创建流策略QOS
	classifier pc1 behavior pc1       //同时应用流分类和流行为
int g0/0/2                            //流策略可以应用在出接口和入接口
	traffci policy outbound
```

### 报文的分类
分类和打标记是在网络的边缘器作用
网络中的核心就可以根据标记来试试相应的QOS服务
1. 传统的工具分类
   在接口下使用acl进行分类，可以和 remark，CAR 一起使用，把全局定义的用于匹配数据报文的acl直接在接口下调用；实施简单，但是匹配能力有限
2. MQC（复杂流分类）
   报文标记：本地优先级，报文优先级
   标记：对分类的流量打上不同的标签，用来区分对待不同的数据
   优先级标记：设备内部优先级（本地优先级）；报文优先级（外部优先级）
   设备内部优先级是对设备内部的数据报文给与一个内部优先级标记，在设备内部分配资源（队列选择）

优先级映射：华为设备在其入接口根据接口信任的信任关系映射表生成内部优先级在出接口上根据内部优先级或802.1p选择出队列，并映射到报文优先级

#### 生成内部优先级工具
1. 信任关系：当报文进入设备内部时，根据接口配置的信任状态决定设备内部的优先级，设备的入接口上设置信任关系会影响内部优先级和报文优先级
	```
	trust [8021p | dscp | exp]
	```
2. 端口优先级：报文进入设备信任802.1p，但是报文本身没有vlan tag，就会使用端口优先级，默认是0
   - 信任是802.1p，收到untag报文，设备会根据端口优先级生成内部优先级
   - 端口非信任，没有trust命令，所有报文都将根据端口优先级进入一个队列，无法进行差分服务
#### 802.1p特点
1. 对于带vlan tag的报文，设备根据报文携带的802.1p优先级来查找优先级映射表，生成内部优先级，确认报文进入的队列，并且修改报文的优先级值
2. 对于不带vlan tag的报文，设备将使用端口优先级作为802.1p优先级来查找优先级映射表，确认报文进入的队列，并且修改报文的优先级值
3. 进入的802.1p为3，在内部使用内部优先级AF31；802.1p为5，在内部优先级为EF
4. 当报文从出接口离开设备时，报文优先级没有被改写
#### 修改优先级
```
int g0/0/0
	//接口下配置信任关系
	//override只会影响经过设备的报文优先级，会被改写成内部优先级
	trust dscp [override]
qos map-table dot1p-dscp
	input 2 output 18
	input 5 output 44

//dscp
qos map-table dscp-dscp
	input 22 output 66
//接口下可以信任exp，但是无法修改优先级
```
### 流量监管和流量整形
#### 流量监管（TP，traffic policing）
通过监督进入设备端口的流量速率，对超出部分进行丢弃，使得进入端口的流量限制再应该合理的范围之内，限制HTTP报文不占用50%（“削顶”处理）
![[Pasted image 20240916102305.png]]
数据流  -->  meter  --(result)-->  marker  -->  action  -->  输出数据流
meter：度量器，通过令牌桶机制对网络流量进行独立，然后向marker输出度量结果
marker：标记器，根据meter的度量结果对报文进行染色，报文会被标记为红黄绿三色
action：根据染色结果，对报文进行行为处理
- pass：对测量结果为符合的报文进行继续转发
- remark+pass：修改报文内部优先级再转发
- discard：对黄色和绿色进行转发，对红色丢弃
#### 流量整形（TS，traffic shaping）
超出的报文缓存等到低峰期再处理；是一种队列的流量控制方法，速率限制
报文--->分类--->队列   没有队列整形，则直接发送；按照用户设定的队列整形速率向令牌桶中放置令牌
放置令牌--->令牌数足够--->直接转发

为控制最大输出通信速率提供可能，当报文的发送速率过快时，首先再缓存区进行缓存，在令牌桶的控制下在均匀的发送这些被缓存的报文（平整转发 ）
![[Pasted image 20240916102344.png]]

### 令牌桶
- 令牌桶（token bucket）：网络设备的内部存储池，用于缓存数据的内存
- 令牌（token）：以给定速率填充令牌桶的虚拟信息包
设备在接收每个帧时都会将一个令牌添加到令牌桶中，但时令牌桶底部有一个孔，不断的按管理员指定作为平均通信速率（bit/s）的速度领出令牌（从桶中删除令牌），其实就是不断从出端口发送数据的过程

单桶单速双色模型：
CBS承诺突发尺寸，C桶；CIR承诺信息速率，TC；标识当前令牌桶中的令牌数
1. 系统按照CIR的速率向令牌桶CBS里添加令牌
2. 当TC < CBS时再比较B（接收数据包的大小）与TC的关系；如果B<=TC，则表示新接收的数据包大小符合规定（conform）可完整的被缓存到令牌桶中，此时数据包被标记为绿色（允许转发），当前的TC值要减少B
3. 如果B > TC，则表示新接收的数据包大小违规（violate），不能完整的被缓存到令牌桶中，此时数据包被标记为红色，并且被直接丢弃，TC值不减少

![[Pasted image 20240916095506.png]]

双桶单速三色模型
除了C桶还有E桶（EBS，超出令牌桶容量的突发令牌桶）
- CIR：承诺信息速率，标识向C桶中填充令牌的平均速率
- CBS：承诺突发尺寸
- EBS：超额突发尺寸

当C桶的令牌满后，超出的令牌将会被放进E桶
1. TC < CBS，则TC增加
2. TC=CBS，TE < EBS，则TE增加
3. TC=CBS，TE=EBS，则都不增加

B <= TC，报文被标记为绿色，且TC减少B
TC < B <= TE，报文被标记为黄色，且TE减少B
B > TE，报文被标记为红色，TC和TE都不减少
缺点：当B一直=1000时，就会导致C桶没有多余的令牌缓存到E桶
![[Pasted image 20240916095533.png]]

双桶双速三色模型
双桶：C桶和P桶，双速：CIR和PIR
- P桶：峰值承诺尺寸
- PIR：峰值信息速率

由P桶先处理，超出P桶大小直接丢弃，数据包小于C桶时由C桶处理
- B > TP，红色丢弃
- TC < B <=TP，黄色，TP减少B
- B<=TC，绿色，<font style="color:ee4444">TP，TC都减少B</font>

![[Pasted image 20240916095557.png]]

C桶就是企业平时的平均流量
单桶单速双色：B=TC，没有突发机制
双桶单速三色：B=TC，B>TC，有E桶进行突发保障，但只是临时的
双桶双速三色：B=TC，直接由P桶处理，可以进行长期突发保障

### 拥塞避免和拥塞管理
#### 拥塞避免
通过监视网络资源（比如队列，内存缓冲区）的使用情况，当拥塞发生时，队列在有拥塞加剧的情况下主动丢弃报文以缓解网络压力，主要是在拥塞前解决问题
策略：
1. 尾丢弃
   每个队列长度是有限的，当队列的长度达到最大值后，所有新入队列的报文（缓存在队列尾部）都将<font style="color:ff2222">被丢弃</font>
   缺点：
   1. 无法区分报文，敏感的或者重要的报文也被丢弃
   2. 会引发TCP全局同步现象（多个TCP主机在队列中因为同时丢弃了各自的TCP链接的报文，导致多个TCP链接同时进入慢启动状态从而导致流量降低，之后又会在某个时间同时出现流量高峰，使网络流量起伏波动）
   3. 软件队列中由于TCP流量调控而导致TCP报文数量减少，此时队列中有UDP报文加入，由于UDP报文不收丢包机制影响，继续以恒定速率进入队列，就会占据过多的空间，导致TCP因为空间存储出现TCP饥饿
2. RED（早期随机丢弃 random early detection）
   在低门槛和高门槛之间随机丢弃一些报文，并且伴随着队列的空间越来越少，丢弃的概率会越来越大；可以缓解拥塞
   缺点：还是无法区分报文
3. WRED（加权早期随机丢弃 weighted random early detection）
   达到一定队列阈值时开始丢弃不同优先级的报文（低优先级优先被丢弃）
   也是起到缓解拥塞的作用
   1. 基于队列（queue profile）的WRED
      drop-profile丢弃模板：队列中各优先级WRED参数的集合，将定义好的丢弃模板在队列模板中关联，然后应用到接口上，当借口发生拥塞时，接口上绑定的丢弃模板就会实现拥塞避免
      ```
		//丢弃模板
		drop-profile drop
			wred dscp
			//当af31优先级的报文在队列中有40到60个时，按比例30%丢弃
			dscp af31 low-limit 40 high-limit 60 discard-percentag 30
		
		//队列模板
		qos queue-profile queue
			schedule wfq 1
			//关联丢弃模板
			queue 1 drop-profile drop
		int g0/0/1
			//接口下调用队列模板
			qos queue-profile queue
		//在流行为下直接调用丢弃模板
		traffic behavior tb
			queue wfq
			drop-profile drop
		```
   low-limit 40：丢弃下限百分比，队列中报文百分比
   high-limit 60：丢弃上仙百分比
#### 拥塞管理
拥塞发生的场景
1. 速率不匹配，报文从高速链路进入设备，再从低速链路转发出去
2. 汇聚问题，报文从多个接口同时进入设备，再由一个没有足够带宽的接口转发出去
拥塞的影响
1. 增加报文传输的时延和抖动
2. 过高的延时会引起报文重传
3. 使网络有效吞吐率降低
4. 加剧网络资源的浪费，尤其是存储资源

拥塞管理是在流量发生拥塞时，保证重要的流量能够通过，普通流量不会饿死

数据流进入软件队列，如果软件队列是空的，且硬件队列没满，就会进入硬件队列系统
如果软件队列系统不是空的或者硬件队列满了，就会进入软件队列系统

队列：在缓存中对报文进行排序的逻辑，当流量速率超过了接口带宽，报文就会以队列的形式暂存在缓存中；每个端口有8个下行队列，称为CQ（class queue），也叫端口队列（port-queue）；分别为BEAF1AF2AF3AF4EFCS6CS7

队列映射（针对软件队列）：本地优先级LP

队列技术
1. FIFO：先进先出；简单，但是不提供报文的质量保证，尾丢弃机制，不同流之间不互相隔离，当某个流的带宽太大会占用其他流的带宽
1. PQ：严格按照优先级的高低进行调度，只有当高优先级报文全部被调度完成之后才会处理低优先级报文
   缺点：低优先级报文可能一直无法被调度
2. SP：严格优先级；按照严格优先级进行调度，只有高优先级的队列排空之后，才会从低一级的队列调度报文；尾丢弃机制，队列内使用FIFO，尽可能保障某类流量得到最好的服务，不管其他流量的死活
3. FQ：公平队列；把进入一个队列的报文称为流，系统对于每个流都是均等的，每个流平等的共享带宽；1M带宽，10个流，100kbit/s，20个流，50kbit/s
4. WFQ：加权公平队列，确保公平的情况下尽量确保高优先级报文转发
5. RR：轮询调度；按照顺序，依次从每个队列按照一个数据包为单位，去除发送
6. WRR：加权轮询调度；根据每个队列的权值，进行轮询调度
   - 高优先级：10，1 2 3 5 7 9 11 13 15
   - 中优先级：8，4 6 8 10 12 14 16
   - 低优先级：2，17
7. DRR：赤字轮询调度；解决WRR不关心报文大小的问题
   

队列调度机制
1. 硬件队列：发送队列，接口驱动在逐个传输数据包的时候需要使用这个队列，一定是FIFO队列；和硬件队列长度和接口带宽设置有关，带宽越大传输时延就小，因为队列可以长一点
2. 软件队列：根据QOS的要求把数据包调度到硬件队列中，一定是在硬件队列满的情况下才会进入到软件队列调度

```
qos queue-profile q1
	//配置队列1-4的调度模式为wfq，队列5-6的调度模式为pq
	schedule wfq 1 to 4 pq 5 to 6
	//设置队列权重
	queue 1 weight 20
	queue 2 weight 30
	//设置队列能够保存的包和最大缓存
	queue 3 length packets 64 bytes 20000
```

CBQ：通过MQC配置；
1. EF队列：严格优先级队列，时候低延时，低丢弃概率，占用带宽不是很大的业务（重要业务报文，音频，视频业务）
2. LLQ队列：低延时队列，它的延时相比EF更低VOIP，比EF队列有更好的优先级转发能力
3. AF队列：带宽保障业务队列，可以结合WRED丢弃策略
4. BE队列：尽力队列，使用接口剩余带宽和WFQ调度方式发送

```
traffic behavior b1
	queue af bandwidth pct 30
	queue-length packets 100
```

### HQOS（层次化QOS hierarchical）
传统的QOS基于端口进行流量调度，HQOS在单个端口下可以区分用户及业务
多级队列调度，解决区分服务模型下多用户多业务带宽的保障

CQ：优先级，权重，整形速率PIR，报文的丢弃策略（尾丢弃或WRED）和port；端口调度算法